-- ============================================================================
-- 修复 game_account.game_player_id 字段的错误数据
-- ============================================================================
-- 问题：之前 game_player_id 可能存储了错误的值（例如 UserID 而不是 GameID）
-- 
-- 测试验证：
--   账号 1106162940:
--     - account = '1106162940' (登录账号)
--     - game_player_id 应该是 '22953243' (Plaza API 返回的 GameID)
--     - 但实际存储的是 '6855890' (这是 UserID，错了！)
--
-- 修复方案：
--   方案1（推荐）：清空错误数据，让用户重新登录时自动更新
--   方案2：手动更新已知正确的值
-- ============================================================================

-- ============================================================================
-- 步骤1：查看当前数据
-- ============================================================================
SELECT 
    id,
    user_id,
    account,
    nickname,
    game_player_id,
    login_mode,
    created_at,
    CASE 
        WHEN game_player_id = '' THEN '未设置'
        WHEN game_player_id = account THEN '可能错误（等于account）'
        ELSE '已设置'
    END as status
FROM game_account
WHERE is_del = 0
ORDER BY id;

-- ============================================================================
-- 步骤2：修复方案1 - 清空错误数据（推荐）
-- ============================================================================
-- 清空所有 game_player_id，让用户重新登录时通过 BindSingle 自动更新
-- 修改后的 BindSingle 方法会在更新时同步 GamePlayerID

-- 先备份当前数据（可选）
-- CREATE TABLE game_account_backup_20251121 AS 
-- SELECT * FROM game_account WHERE is_del = 0;

-- 清空 game_player_id
UPDATE game_account 
SET game_player_id = '', 
    updated_at = NOW()
WHERE is_del = 0;

-- ============================================================================
-- 步骤3：验证修复结果
-- ============================================================================
SELECT 
    id,
    account,
    game_player_id,
    CASE 
        WHEN game_player_id = '' THEN '✓ 已清空，等待用户登录更新'
        ELSE game_player_id
    END as new_status
FROM game_account
WHERE is_del = 0
ORDER BY id;

-- ============================================================================
-- 步骤4（可选）：手动更新已知正确的值
-- ============================================================================
-- 如果你已经通过测试知道某些账号的正确 game_player_id，可以手动更新
-- 例如：账号 1106162940 的正确值是 22953243

-- UPDATE game_account
-- SET game_player_id = '22953243',
--     updated_at = NOW()
-- WHERE account = '1106162940' AND is_del = 0;

-- ============================================================================
-- 注意事项
-- ============================================================================
-- 1. 清空后，用户下次登录时会自动填充正确的 game_player_id
-- 2. 已修复的代码在 /internal/biz/game/game_account.go 的 BindSingle 方法中
-- 3. 该方法现在会在更新已存在账号时同步更新 GamePlayerID 和 Nickname
-- 4. 对于未绑定用户的账号，会在绑定时自动填充
-- ============================================================================
