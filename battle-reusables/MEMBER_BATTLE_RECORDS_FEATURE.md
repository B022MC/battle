# 成员战绩查看功能

## ✅ 当前状态：已完成并启用

**后端**：`/battle-query/group/battles` 接口已实现
**前端**：战绩显示功能已启用
**部署**：功能已可用

---

## 📋 功能概述

店铺管理员可以在游戏成员列表中查看自己圈子成员的战绩记录。

## 🎯 功能特点

### 1. **查看战绩**
- ✅ 只对**自己圈子**的成员显示战绩查看按钮
- ✅ 点击"📊 查看战绩"按钮展开战绩列表
- ✅ 自动加载最近 10 条战绩记录
- ✅ 点击"📊 收起战绩"按钮隐藏战绩列表

### 2. **战绩显示内容**
每条战绩显示：
- 📅 **对战时间**：格式化为 `MM/DD HH:mm`
- 💰 **输赢分数**：
  - 正数显示绿色 `+X.XX`
  - 负数显示红色 `-X.XX`
- 🏠 **房间信息**：房间号和底分
- 💵 **当前余额**：对战后的余额
- 💸 **手续费**：如果有手续费则显示

### 3. **权限控制**
- 需要有圈子ID (`myGroupId`)
- 只显示当前圈子成员的战绩 (`current_group_id === myGroupId`)
- 需要有 `house_gid`（店铺ID）

## 🔧 技术实现

### 后端 API

使用 `/battle-query/group/battles` 接口查询圈子成员战绩：

```typescript
listGroupBattles({
  house_gid: number,
  group_id: number,
  player_game_id: number,
  page: 1,
  size: 10,
})
```

### 前端实现

**文件**：`/components/(tabs)/tables/members-list.tsx`

**新增状态**：
```typescript
const [expandedBattleIds, setExpandedBattleIds] = useState<Set<string>>(new Set());
const [battleRecords, setBattleRecords] = useState<Record<string, BattleRecord[]>>({});
const [loadingBattles, setLoadingBattles] = useState<Set<string>>(new Set());
```

**关键函数**：
1. `loadBattleRecords` - 加载战绩数据
2. `toggleBattleExpand` - 切换展开/收起状态
3. `formatTime` - 格式化时间显示
4. `formatScore` - 格式化分数（分转元）

## 📱 用户界面

### 成员卡片结构

```
┌─────────────────────────────────┐
│ 玩家昵称                        │
│ GameID: 12345  MemberID: 1001  │
│ ● 圈子A                         │
│ 💬 备注内容                     │
│                                 │
│ [➕ 添加备注]                  │
│ [📊 查看战绩]  ← 新增按钮      │
│ [上分] [下分]                   │
└─────────────────────────────────┘
```

### 展开战绩后

```
┌─────────────────────────────────┐
│ [📊 收起战绩]                   │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ 11/29 14:30        +12.50   │ │
│ │ 房间 1001 · 底分 1          │ │
│ │ 余额 150.00                 │ │
│ │ 手续费 -0.50                │ │
│ └─────────────────────────────┘ │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ 11/29 13:15        -8.00    │ │
│ │ 房间 1002 · 底分 1          │ │
│ │ 余额 138.00                 │ │
│ └─────────────────────────────┘ │
│                                 │
│ [上分] [下分]                   │
└─────────────────────────────────┘
```

## 🎨 样式说明

### 颜色规则
- **赢分**：绿色文字 (`text-green-600 dark:text-green-400`)
- **输分**：红色文字 (`text-red-600 dark:text-red-400`)
- **战绩卡片**：次要背景 (`bg-secondary/30`)
- **辅助信息**：静音前景色 (`text-muted-foreground`)

### 数据格式
- **时间**：`MM/DD HH:mm` (如：`11/29 14:30`)
- **金额**：保留两位小数，单位为元 (如：`12.50`、`-8.00`)
- **正数前缀**：自动添加 `+` 号

## ✅ 显示条件

战绩查看按钮显示需要同时满足：
1. ✅ `item.game_player_id` 存在
2. ✅ `item.game_id` 存在
3. ✅ `myGroupId` 存在（店铺管理员有圈子）
4. ✅ `item.current_group_id === myGroupId`（成员在当前圈子中）

## 📊 数据流程

```
1. 用户点击"查看战绩"
   ↓
2. 检查是否已加载过战绩
   ↓
3. 如果未加载，调用 listGroupBattles API
   ↓
4. 将战绩数据存储到 battleRecords 状态
   ↓
5. 展开战绩列表
   ↓
6. 渲染战绩卡片
```

## 🔍 使用场景

### 店铺管理员场景
1. **查看成员输赢**：了解圈子成员的游戏表现
2. **决定上分下分**：根据战绩和余额决定是否需要调整额度
3. **监控异常**：发现异常输赢情况

### 数据示例

**API 返回数据**：
```json
{
  "list": [
    {
      "id": 12345,
      "house_gid": 1,
      "group_id": 9,
      "room_uid": 1001,
      "kind_id": 1,
      "base_score": 1,
      "battle_at": "2025-11-29T14:30:00Z",
      "player_game_id": 22953243,
      "score": 1250,
      "fee": 50,
      "player_balance": 15000,
      "created_at": "2025-11-29T14:30:05Z"
    }
  ],
  "total": 1
}
```

**前端显示**：
```
11/29 14:30              +12.50
房间 1001 · 底分 1
余额 150.00
手续费 -0.50
```

## 🚀 部署说明

### 前端
- ✅ 已集成到 `members-list.tsx` 组件
- ✅ 自动适配圈子成员显示
- ✅ 无需额外配置

### 后端
- ✅ 确保 `/battle-query/group/battles` 接口正常工作
- ✅ 确保战绩数据及时同步

## 📝 注意事项

1. **性能优化**：战绩数据按需加载，只在点击时才请求
2. **状态管理**：使用 Set 和 Record 高效管理展开状态和数据缓存
3. **用户体验**：加载中显示"加载中..."，避免重复点击
4. **权限隔离**：只显示自己圈子的成员战绩，确保数据安全

## 🎯 未来优化方向

- [ ] 添加日期筛选功能
- [ ] 添加分页加载更多战绩
- [ ] 添加战绩统计汇总
- [ ] 支持导出战绩数据
- [ ] 添加战绩趋势图表
